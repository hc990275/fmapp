name: âš¡ Quick Sync OK Branch & Telegram Deploy (Final)

on:
  # æ¯åŠå°æ—¶è‡ªåŠ¨è¿è¡Œ
  schedule:
    - cron: '*/30 * * * *'
  # å…è®¸æ‰‹åŠ¨åœ¨ Actions é¡µé¢è§¦å‘
  workflow_dispatch:

# æƒé™é…ç½®
permissions:
  contents: write 

jobs:
  sync_and_deploy:
    name: 1. Sync 'ok' Branch and Deploy
    runs-on: ubuntu-latest
    
    steps:
      - name: â¬‡ï¸ Checkout 'ok' branch (å¿«é€Ÿæµ…å…‹éš†)
        uses: actions/checkout@v4
        with:
          # åªæ‹‰å– ok åˆ†æ”¯çš„æœ€æ–°æäº¤ï¼ŒåŠ å¿«é€Ÿåº¦
          ref: ok
          fetch-depth: 1 
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: âš™ï¸ Configure Git User
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

      - name: ğŸ”— Add Upstream Remote and Fetch
        run: |
          # 1. æ·»åŠ ä¸Šæ¸¸ä»“åº“ä¸ºè¿œç¨‹æº
          git remote add upstream https://github.com/lystv/fmapp.git
          # 2. æ˜ç¡®æ‹‰å–ä¸Šæ¸¸ ok åˆ†æ”¯çš„æœ€æ–°çŠ¶æ€
          git fetch upstream ok
          
      - name: ğŸ’¾ Merge Upstream into 'ok'
        id: merge
        run: |
          # å°è¯•åˆå¹¶ä¸Šæ¸¸ ok åˆ†æ”¯åˆ°æœ¬åœ° ok
          if git merge upstream/ok --allow-unrelated-histories --no-edit; then
            echo "Merge successful."
          else
            echo "Merge failed. Conflicts need manual resolution. Exiting."
            exit 1 
          fi

      - name: â¬†ï¸ Push Changes and Check Status
        id: push_check
        run: |
          # æ£€æŸ¥æœ¬åœ°åˆ†æ”¯æ˜¯å¦é¢†å…ˆäºè¿œç¨‹ origin/ok (å³æœ‰æ–°åˆå¹¶)
          if git diff --quiet origin/ok ok; then
            echo "No new changes detected. Skipping push and deployment."
            echo "has_pushed=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected. Pushing to origin/ok..."
            # æ¨é€åˆå¹¶åçš„æ›´æ”¹åˆ°æ‚¨çš„ Fork ä»“åº“
            git push origin ok
            echo "has_pushed=true" >> $GITHUB_OUTPUT
          fi
          
      # -----------------------------------------------------
      # ç¬¬äºŒéƒ¨åˆ†ï¼šTelegram éƒ¨ç½²
      # -----------------------------------------------------

      - name: ğŸ“¢ Send Notification and Files to Telegram
        # ä»…åœ¨ä¸Šä¸€æ­¥æœ‰æ–°æ¨é€æ—¶æ‰æ‰§è¡Œéƒ¨ç½²
        if: steps.push_check.outputs.has_pushed == 'true'
        run: |
          TELEGRAM_BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}"
          TELEGRAM_CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}"
          
          # --- 1. è¯»å–ç‰ˆæœ¬ä¿¡æ¯ ---
          
          # è¯»å– v.txt çš„å†…å®¹ï¼Œä½œä¸ºä¸»è¦ç‰ˆæœ¬å·
          PRO_VERSION=$(head -n 1 ./apk/pro/v.txt 2>/dev/null || echo "Pro Version Not Found")

          # ä¿®å¤äº† YAML è¯­æ³•é”™è¯¯ï¼šå°† VERSION_MESSAGE å®šä¹‰ä¸ºå•è¡Œå­—ç¬¦ä¸²
          VERSION_MESSAGE="ğŸš€ *OKå½±è§† 'ok' åˆ†æ”¯åŒæ­¥æˆåŠŸ* ğŸš€\n\n--- ğŸ“Š *ç‰ˆæœ¬ä¿¡æ¯* ğŸ“Š ---\n*Pro ç‰ˆæœ¬ (v.txt):* \`${PRO_VERSION}\`\n*Mobile (æ‰‹æœºç‰ˆ):* è¯¦è§é™„ä»¶ mobile.json\n*Leanback (ç”µè§†ç‰ˆ):* è¯¦è§é™„ä»¶ leanback.json\n\næ–°æ–‡ä»¶å·²æ›´æ–°ï¼Œæ­£åœ¨å‘é€é™„ä»¶..."
          
          # 2. å‘é€åˆå§‹æˆåŠŸæ¶ˆæ¯
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d "chat_id=$TELEGRAM_CHAT_ID" \
            -d "parse_mode=Markdown" \
            -d "text=$VERSION_MESSAGE"

          # 3. æŸ¥æ‰¾å¹¶å‘é€æŒ‡å®šè·¯å¾„ä¸‹çš„æ‰€æœ‰ APK å’Œç‰ˆæœ¬ JSON/TXT æ–‡ä»¶
          find ./apk/release/ ./apk/pro/ \( -name "*.apk" -o -name "*.json" -o -name "v.txt" \) -type f > /tmp/files_to_send.txt

          # 4. å¾ªç¯å‘é€æ–‡ä»¶
          while IFS= read -r FILE_PATH; do
            if [ -f "$FILE_PATH" ]; then
              FILE_BASENAME=$(basename "$FILE_PATH")
              # ä½¿ç”¨ sendDocument API å‘é€æ–‡ä»¶
              curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendDocument" \
                -F "chat_id=$TELEGRAM_CHAT_ID" \
                -F "caption=æ–‡ä»¶: ${FILE_BASENAME}" \
                -F "document=@$FILE_PATH"
            fi
          done < /tmp/files_to_send.txt

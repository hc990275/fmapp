name: ğŸš€ Quick Sync OK Branch & Telegram Deploy

on:
  # æ¯åŠå°æ—¶è‡ªåŠ¨è¿è¡Œ
  schedule:
    - cron: '*/30 * * * *'
  # å…è®¸æ‰‹åŠ¨åœ¨ Actions é¡µé¢è§¦å‘
  workflow_dispatch:

# æƒé™é…ç½®
permissions:
  contents: write 

jobs:
  sync_and_deploy:
    name: 1. Sync 'ok' Branch and Deploy
    runs-on: ubuntu-latest
    
    steps:
      - name: â¬‡ï¸ Checkout 'ok' branch (å¿«é€Ÿæµ…å…‹éš†)
        uses: actions/checkout@v4
        with:
          # åªæ‹‰å– ok åˆ†æ”¯ï¼Œå¹¶ä¸”åªæ‹‰å–æœ€è¿‘ä¸€æ¬¡æäº¤ (fetch-depth: 1)ï¼Œå¤§å¹…åŠ é€Ÿ
          ref: ok
          fetch-depth: 1 
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: âš™ï¸ Configure Git User
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

      - name: ğŸ”— Add Upstream Remote and Fetch
        run: |
          git remote add upstream https://github.com/lystv/fmapp.git
          # æ˜ç¡®æ‹‰å–ä¸Šæ¸¸ ok åˆ†æ”¯
          git fetch upstream ok
          
      - name: ğŸ’¾ Merge Upstream into 'ok'
        id: merge
        run: |
          echo "Attempting to merge upstream/ok into local ok branch..."
          # å°è¯•åˆå¹¶ä¸Šæ¸¸ ok åˆ†æ”¯åˆ°æœ¬åœ° ok
          if git merge upstream/ok --allow-unrelated-histories --no-edit; then
            echo "Merge successful."
          else
            echo "Merge failed. Conflicts need manual resolution."
            # åœ¨å†²çªå‘ç”Ÿæ—¶é€€å‡ºï¼Œé˜»æ­¢åç»­éƒ¨ç½²æ­¥éª¤
            exit 1 
          fi

      - name: â¬†ï¸ Push Changes and Check Status
        id: push_check
        run: |
          # æ£€æŸ¥æœ¬åœ° ok åˆ†æ”¯æ˜¯å¦é¢†å…ˆäºè¿œç¨‹ origin/ok (å³æœ‰æ–°åˆå¹¶)
          if git diff --quiet origin/ok ok; then
            echo "No new changes detected. Skipping push."
            echo "has_pushed=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected. Pushing to origin/ok..."
            # æ¨é€åˆå¹¶åçš„æ›´æ”¹åˆ°æ‚¨çš„ Fork ä»“åº“
            git push origin ok
            echo "has_pushed=true" >> $GITHUB_OUTPUT
          fi
          
      # -----------------------------------------------------
      # ç¬¬äºŒéƒ¨åˆ†ï¼šTelegram éƒ¨ç½² (ä»…åœ¨æ–°ä»£ç è¢«æ¨é€åæ‰§è¡Œ)
      # -----------------------------------------------------

      - name: ğŸ“¢ Send Notification and Files to Telegram
        # ä»…åœ¨ä¸Šä¸€æ­¥æœ‰æ–°æ¨é€æ—¶æ‰æ‰§è¡Œéƒ¨ç½²
        if: steps.push_check.outputs.has_pushed == 'true'
        run: |
          TELEGRAM_BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}"
          TELEGRAM_CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}"
          
          echo "Start sending files from 'ok' branch to Telegram chat ID: $TELEGRAM_CHAT_ID"

          # 1. å‘é€åˆå§‹æˆåŠŸæ¶ˆæ¯
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d "chat_id=$TELEGRAM_CHAT_ID" \
            -d "parse_mode=Markdown" \
            -d "text=ğŸš€ *OKå½±è§† 'ok' åˆ†æ”¯åŒæ­¥ä¸æ–‡ä»¶éƒ¨ç½²æˆåŠŸ* ğŸš€\n\næ‚¨çš„ä»“åº“ (`hc990275/fmapp:ok`) å·²ä»ä¸Šæ¸¸æ›´æ–°ï¼Œå¹¶å¼€å§‹å‘é€æ›´æ–°æ–‡ä»¶ã€‚"

          # 2. æŸ¥æ‰¾å¹¶å‘é€æŒ‡å®šè·¯å¾„ä¸‹çš„æ–‡ä»¶
          echo "Searching for files in ./apk/release/ and ./apk/pro/..."
          
          # æŸ¥æ‰¾æ‰€æœ‰ APK å’Œ JSON æ–‡ä»¶ (ä»…å…³æ³¨æ‚¨æŒ‡å®šçš„ä¸¤ä¸ªç›®å½•)
          find ./apk/release/ ./apk/pro/ \( -name "*.apk" -o -name "*.json" \) -type f > /tmp/files_to_send.txt

          # 3. å¾ªç¯å‘é€æ–‡ä»¶
          while IFS= read -r FILE_PATH; do
            if [ -f "$FILE_PATH" ]; then
              echo "Uploading $FILE_PATH..."
              # ä½¿ç”¨ sendDocument API å‘é€æ–‡ä»¶
              curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendDocument" \
                -F "chat_id=$TELEGRAM_CHAT_ID" \
                -F "caption=æ–‡ä»¶æ›´æ–°: $(basename $FILE_PATH)" \
                -F "document=@$FILE_PATH"
            else
              echo "File not found: $FILE_PATH"
            fi
          done < /tmp/files_to_send.txt
